name: Release Browser Extensions

on:
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.2.3)"
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: extension/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install
        working-directory: extension

      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Update version in package.json and metadata.json
        run: |
          node -e "const fs=require('fs'); const pkg=JSON.parse(fs.readFileSync('package.json')); pkg.version='${{ steps.version.outputs.VERSION }}'; fs.writeFileSync('package.json', JSON.stringify(pkg,null,2));"
          node -e "const fs=require('fs'); const meta=JSON.parse(fs.readFileSync('metadata.json')); meta.version='${{ steps.version.outputs.VERSION }}'; fs.writeFileSync('metadata.json', JSON.stringify(meta,null,2));"
        working-directory: extension

      - name: Build extension
        run: pnpm run bundle
        working-directory: extension

      - name: Create dist directory
        run: mkdir -p extension/dist

      - name: Pack extension directory
        id: packExtensionDir
        uses: cardinalby/webext-buildtools-pack-extension-dir-action@v1
        with:
          extensionDir: "extension/build"
          zipFilePath: "extension/dist/extension.zip"

      - name: Install web-ext
        run: npm install -g web-ext

      - name: Sign XPI package with web-ext
        run: |
          web-ext sign \
            --source-dir=extension/build \
            --artifacts-dir=extension/dist \
            --api-key=${{ secrets.FIREFOX_API_KEY }} \
            --api-secret=${{ secrets.FIREFOX_API_SECRET }} \
            --channel=listed
        continue-on-error: true

      - name: Create XPI package
        run: |
          if ls extension/dist/locam*.xpi 2>/dev/null; then
            mv extension/dist/locam*.xpi extension/dist/locam-v${{ steps.version.outputs.VERSION }}.xpi 2>/dev/null || true
          fi
          if [ ! -f extension/dist/locam-v${{ steps.version.outputs.VERSION }}.xpi ]; then
            cp extension/dist/extension.zip extension/dist/locam-unsigned-v${{ steps.version.outputs.VERSION }}.xpi
          fi

      - name: Create Zip package
        run: cp extension/dist/extension.zip extension/dist/locam-v${{ steps.version.outputs.VERSION }}.zip

      - name: Create CRX file
        uses: cardinalby/webext-buildtools-chrome-crx-action@v2
        with:
          zipFilePath: "extension/dist/extension.zip"
          crxFilePath: "extension/dist/locam-v${{ steps.version.outputs.VERSION }}.crx"
          privateKey: ${{ secrets.CHROME_CRX_PRIVATE_KEY }}
        continue-on-error: true

      - name: Generate checksums
        run: |
          cd extension/dist
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            extension/dist/locam-v${{ steps.version.outputs.VERSION }}.xpi
            extension/dist/locam-v${{ steps.version.outputs.VERSION }}.zip
            extension/dist/locam-v${{ steps.version.outputs.VERSION }}.crx
            extension/dist/checksums.txt
          body: |
            ## Locam v${{ steps.version.outputs.VERSION }}

            ### Installation

            **Firefox:**
            Recommended Way:
              - get from [Official Addon Store](https://addons.mozilla.org/en-US/firefox/addon/locam-private-qr-scanner/)

            Manual Way:
              1. Download `locam-v${{ steps.version.outputs.VERSION }}.xpi`
              2. Go to `about:addons`
              3. Click the gear icon and select "Install Add-on From File"
              4. Select the downloaded zip file

            **Chrome/Edge/Brave:**
            1. Download `locam-chrome-v${{ steps.version.outputs.VERSION }}.zip`
            2. Extract the zip file
            3. Go to `chrome://extensions/`
            4. Enable "Developer mode"
            5. Click "Load unpacked" and select the extracted folder

            **Chrome (CRX - Advanced):**
            1. Download `locam-v${{ steps.version.outputs.VERSION }}.crx`
            2. Drag and drop to `chrome://extensions/`

            ### Checksums
            See `checksums.txt` for SHA256 checksums of all files.
          draft: false
          prerelease: false
          generate_release_notes: true

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
